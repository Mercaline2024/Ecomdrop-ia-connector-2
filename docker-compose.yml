version: "3.8"

services:
  ## --------------------------- MYSQL 8.0 (PRIMERO) --------------------------- ##
  
  mysql:
    image: mysql:8.0
    
    networks:
      - EcomdropNet
    
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: shopify_app
      MYSQL_USER: shopify_user
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: America/Bogota
    
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
      - --max_allowed_packet=256M
      - --innodb_buffer_pool_size=768M
      - --max_connections=200
    
    volumes:
      - mysql_data:/var/lib/mysql
    
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p$${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      
      resources:
        limits:
          cpus: "1.5"
          memory: 1536M
        reservations:
          cpus: "0.5"
          memory: 768M
      
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s

  ## --------------------------- SHOPIFY APP --------------------------- ##
  
  shopify_app:
    image: shopify-app_shopify_app:latest
    
    networks:
      - EcomdropNet
    
    environment:
      ## üóÑÔ∏è Base de Datos
      DATABASE_URL: mysql://shopify_user:${MYSQL_PASSWORD}@mysql:3306/shopify_app
      
      ## üîê Shopify API
      SHOPIFY_API_KEY: ${SHOPIFY_API_KEY}
      SHOPIFY_API_SECRET: ${SHOPIFY_API_SECRET}
      SCOPES: read_products,write_products,read_orders,read_themes,write_themes
      SHOPIFY_APP_URL: https://shopify.ecomdrop.io
      
      ## üåê Configuraci√≥n
      NODE_ENV: production
      PORT: 3000
      TZ: America/Bogota
      
      ## üé® Theme 2.5 (Opcional)
      THEME_2_5_GIT_REPO: ${THEME_2_5_GIT_REPO}
      THEME_2_5_GIT_BRANCH: ${THEME_2_5_GIT_BRANCH}
      THEME_2_5_GIT_PROVIDER: ${THEME_2_5_GIT_PROVIDER}
      THEME_2_5_GIT_TOKEN: ${THEME_2_5_GIT_TOKEN}
      
      ## üè™ Dominio (Opcional)
      SHOP_CUSTOM_DOMAIN: ${SHOP_CUSTOM_DOMAIN}
    
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      
      resources:
        limits:
          cpus: "1.5"
          memory: 1536M
        reservations:
          cpus: "0.5"
          memory: 768M
      
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 5
        window: 180s
      
      labels:
        - traefik.enable=true
        - traefik.http.routers.shopify_app.rule=Host(`shopify.ecomdrop.io`)
        - traefik.http.routers.shopify_app.entrypoints=websecure
        - traefik.http.routers.shopify_app.tls.certresolver=letsencryptresolver
        - traefik.http.routers.shopify_app.service=shopify_app
        - traefik.http.services.shopify_app.loadbalancer.server.port=3000
        - traefik.http.services.shopify_app.loadbalancer.passhostheader=true
        - traefik.http.routers.shopify_app.middlewares=shopify_app-headers
        - traefik.http.middlewares.shopify_app-headers.headers.customrequestheaders.X-Forwarded-Proto=https
        - traefik.http.middlewares.shopify_app-headers.headers.sslredirect=true
    
    depends_on:
      - mysql

## --------------------------- REDES --------------------------- ##

networks:
  EcomdropNet:
    external: true
    name: EcomdropNet

## --------------------------- VOL√öMENES --------------------------- ##

volumes:
  mysql_data:
    driver: local